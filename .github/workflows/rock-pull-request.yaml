name: Pull Request
# quality checks to make sure the change won't break things

on:
  workflow_call:


jobs:
  changes:
    name: Determine modified rocks
    runs-on: ubuntu-latest
    outputs:
      versions: ${{ steps.changed-versions.outputs.versions }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Determine any rockcraft.yaml changed in the PR
        id: changed-files
        uses: tj-actions/changed-files@v43
        with:
          files: "**/rockcraft.yaml"
      - name: Extract the versions
        id: changed-versions
        run: |
          versions=""
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            rock_version="$(dirname $file)"
            versions="${versions# } $rock_version"
          done
          # Format the list of versions to export on $GITHUB_OUTPUT: ["1.0", "1.1"]
          versions_list="$(echo $versions | jq -rcR 'split(" ")')"
          echo "versions=$versions_list"
          echo "versions=$versions_list" >> $GITHUB_OUTPUT

  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: [changes]
    strategy:
      fail-fast: false
      matrix:
        rock-version: ${{ fromJSON(needs.changes.outputs.versions) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo snap install concierge --classic
          # We need the kubectl *classic* snap because `kgoss` needs access to the /tmp directory
          sudo concierge prepare -p microk8s --extra-snaps rockcraft,just,kubectl
          sudo microk8s enable registry
          # FIXME: install via the goss snap when available
          goss_base_url="https://github.com/goss-org/goss/releases/latest/download"
          curl -L ${goss_base_url}/goss-linux-amd64 -o /usr/local/bin/goss
          chmod +rx /usr/local/bin/goss
          curl -L ${goss_base_url}/kgoss -o /usr/local/bin/kgoss
          chmod +rx /usr/local/bin/kgoss
      - name: Pack and test the rocks
        run: |
          just pack "${{ matrix.rock-version }}"
          just test "${{ matrix.rock-version }}"
