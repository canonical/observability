name: Pull Request
# quality checks to make sure the change won't break things

on:
  workflow_call:


jobs:
  test:
    name: Test the rock
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Determine any rockcraft.yaml changed in the PR
        id: changed-files
        uses: tj-actions/changed-files@v43
        with:
          files: "**/rockcraft.yaml"
      - name: Install dependencies
        run: |
          # We need the microk8s *classic* snap because `kgoss` needs access to the /tmp directory
          sudo snap install microk8s --channel=1.31/stable --classic
          sudo microk8s enable registry
          sudo snap install just
          # FIXME: install via the goss snap when available
          goss_base_url="https://github.com/goss-org/goss/releases/latest/download"
          curl -L ${goss_base_url}/goss-linux-amd64 -o /usr/local/bin/goss
          chmod +rx /usr/local/bin/goss
          curl -L ${goss_base_url}/kgoss -o /usr/local/bin/kgoss
      - name: Pack and test the rocks
        run: |
          # For all the rocks modified in the PR
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            # Initialize variables
            echo "Testing version ${file%/*}"
            rock_folder="${file%/*}"
            rock_version="$(basename $rock_folder)"
            just pack "$rock_version"
            just test "$rock_version"
            pushd "$rock_folder"
            rockcraft clean && rm "*.rock"
            popd
          done
