# Dashboard collisions in Grafana
**Date:** 2024-08-29<br/>
**Authors:** @lucabello


## Context and Problem Statement
Dashboard json includes keys such as in the following example:
```bash
$ cat metrics-dashboard.json | jq '{"title", "uid", "version", "tags"}'
{
  "title": "Loki Operator Overview",
  "uid": "loki",
  "version": 1,
  "tags": [
    "loki"
  ]
}
```

Grafana [documented](https://grafana.com/docs/grafana/latest/administration/provisioning/#reusable-dashboard-urls) that dashboards should not have the same *title* within a folder, or the same *uid* within installations.

This causes some problems in different scenarios.

### Problem 1: Two charms on different revisions

`charm(rev1, dashboard v1) <--> grafana <--> charm(rev2, dashboard v2)`

Unless manually modified, `dashboard v1` and `dashboard v2` have the same *title* and *uid*, which will cause problems in Grafana.

### Problem 2: Collision in UID or Title for different charms

`loki(dashboard "Overview") <--> grafana <--> tempo(dashboard "Overview")`

If both charms have a dashboard simply named "Overview", we have problems. Suggesting a UID and Title to be manually upgraded on every dashboard modification (to avoid (1)) seems like a tedious UX.

## Potential requirements

| Knobs / Requirements        | Deterministic links[^DbURL] | Same link across upgrades | User-controlled folder structure |
|-----------------------------|---------------------|---------------------------|----------------------------------|
| uid                         |                     |                           |                                  |
| rev                         |                     |                           |                                  |
| title                       |                     |                           |                                  |
| Prescribed folder structure |                     |                           |                                  |

[^DbURL]: Dashboard URL is determined by its UID and the chain of parent folders under which it is stored on disk. 


## Decision

We have chosen the solution ???.


## Solutions Considered

### Solution 1: On collision, keep latest dashboard revision

If we received a "newer dashboard" from a higher revision of a charm, we'd only keep the latest dashboard.

**Advantages**: Solves (1), shouldn't be hard to implement.
**Disadvantages**: Doesn't solve (2).

### Solution 2: Generate UID and inject charm revision in the title

The *uid* can be generated by something (like the dashboard JSON) and changed on-the-fly, and we could inject the charm revision and/or name in the *title* (is there a size limit?).

**Advantages**: Solves(1) and (2).
**Disadvantages**: potentially more implementation work.

### Solution 3: Folders by charm name

We create a folder per charm (using the charm name) and put the dashboard in there. However, the folder names goes to the URL and would break links on upgrade.

### Solution 4: Add a feature for charm authors to specify which folder they want to use

This would solve (2) if charm authors configure their charms correctly. The default behavior would be either the "General" folder (as it is right now) or a folder named after the charm name.

**Advantages**: Solves(2) and allows solutions to have a unified folder (e.g., a `COS` folder for all of our charms).
**Disadvantages**: ?.
